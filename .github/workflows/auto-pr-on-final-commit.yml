name: Auto PR on Final Commit

on:
  push:
    branches-ignore:
      - main
      - staging
      - development

jobs:
  auto-create-pr:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'final commit')

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract branch info
        id: branchinfo
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Detected branch: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" == dev-* ]]; then
            BASE_BRANCH="development"
          elif [[ "$BRANCH_NAME" == staging-* ]]; then
            BASE_BRANCH="staging"
          elif [[ "$BRANCH_NAME" == main-* ]]; then
            BASE_BRANCH="main"
          else
            BASE_BRANCH="development"
          fi

          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      - name: Fetch all branches for diff check
        run: git fetch --all

      - name: Create Pull Request using GitHub CLI
        run: |
          BRANCH_NAME="${{ steps.branchinfo.outputs.branch }}"
          BASE_BRANCH="${{ steps.branchinfo.outputs.base_branch }}"

          echo "üß™ Checking for existing PR from '$BRANCH_NAME' to '$BASE_BRANCH'..."

          PR_EXISTS=$(gh pr list \
            --head "$BRANCH_NAME" \
            --base "$BASE_BRANCH" \
            --state open \
            --json number --jq '.[0].number')

          if [[ -n "$PR_EXISTS" ]]; then
            echo "‚ö†Ô∏è PR already exists: #$PR_EXISTS"
            exit 0
          fi

          # Check if there are any changes between branches
          echo "üîç Checking diff between '$BASE_BRANCH' and '$BRANCH_NAME'..."
          COMMITS=$(git rev-list "$BASE_BRANCH..$BRANCH_NAME" --count)

          if [[ "$COMMITS" -eq 0 ]]; then
            echo "‚ö†Ô∏è No changes between '$BRANCH_NAME' and '$BASE_BRANCH'. Skipping PR."
            exit 0
          fi

          echo "üöÄ Creating Pull Request from '$BRANCH_NAME' to '$BASE_BRANCH'..."

          gh pr create \
            --title "Auto PR from $BRANCH_NAME" \
            --body "Automatically generated PR:\n- **Source:** \`$BRANCH_NAME\`\n- **Target:** \`$BASE_BRANCH\`\n- Triggered by \`final commit\`" \
            --base "$BASE_BRANCH" \
            --head "$BRANCH_NAME" \
            --reviewer your-github-username || {
              echo "‚ùå Failed to create PR. Possibly due to incorrect head/base."
              exit 1
            }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
