name: Auto PR on Final Commit

on:
  push:
    branches-ignore:
      - main
      - staging
      - development
      # Add this permissions block if you encounter permission errors
permissions:
  pull-requests: write
  contents: write # Needed for checkout actions if you were doing commits, but good to have if you need to fetch info

jobs:
  auto-create-pr:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'final commit')

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract branch name and determine base branch
        id: branchinfo
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Current branch: $BRANCH_NAME"

          BASE_BRANCH="development"
          if [[ "$BRANCH_NAME" == dev-* ]]; then
            BASE_BRANCH="development"
          elif [[ "$BRANCH_NAME" == staging-* ]]; then
            BASE_BRANCH="staging"
          elif [[ "$BRANCH_NAME" == main-* ]]; then
            BASE_BRANCH="main"
          fi

          echo "Determined base branch: $BASE_BRANCH"
          echo "branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          echo "base_branch=$BASE_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Install GitHub CLI (Latest Stable Version)
        run: |
          # **IMPORTANT**: Check the GitHub CLI releases page for the absolute latest stable version and its .deb URL.
          # As of July 2025, v2.50.0 is an example of a recent version that supports --json and --fill-* flags.
          # Adjust the version number (e.g., v2.50.0) in the URL below if a newer stable release is available.
          GH_CLI_VERSION="2.50.0" # <--- UPDATE THIS TO THE LATEST STABLE VERSION
          GH_CLI_DEB_URL="https://github.com/cli/cli/releases/download/v${GH_CLI_VERSION}/gh_${GH_CLI_VERSION}_linux_amd64.deb"

          echo "Downloading GitHub CLI v${GH_CLI_VERSION} from: ${GH_CLI_DEB_URL}"
          curl -fsSL "$GH_CLI_DEB_URL" -o gh.deb
          sudo dpkg -i gh.deb
          gh --version # Verify installation

      - name: Create Pull Request
        id: create_pr
        env:
          GH_TOKEN: ${{ github.token }}
          SOURCE_BRANCH: ${{ steps.branchinfo.outputs.branch }}
          TARGET_BASE_BRANCH: ${{ steps.branchinfo.outputs.base_branch }}
        run: |
          echo "📌 Creating PR from '$SOURCE_BRANCH' to '$TARGET_BASE_BRANCH'..."

          # Check if a PR already exists from SOURCE_BRANCH to TARGET_BASE_BRANCH
          # This requires a gh CLI version that supports --json with 'gh pr list'
          EXISTING_PR_NUMBER=$(gh pr list --head "$SOURCE_BRANCH" --base "$TARGET_BASE_BRANCH" --state open --json number --jq '.[0].number' 2>/dev/null)
          # 2>/dev/null redirects stderr to null, so it doesn't clutter logs if no PRs are found and jq returns nothing.

          if [[ -n "$EXISTING_PR_NUMBER" ]]; then
            echo "⚠️ PR already exists: #$EXISTING_PR_NUMBER"
            echo "pr_url=https://github.com/${GITHUB_REPOSITORY}/pull/$EXISTING_PR_NUMBER" >> "$GITHUB_OUTPUT"
            exit 0 # Exit successfully if PR already exists
          fi

          # Create the new Pull Request
          # This requires a gh CLI version that supports --json and --fill-* flags with 'gh pr create'
          PR_OUTPUT=$(gh pr create \
              --title "Auto PR: $SOURCE_BRANCH to $TARGET_BASE_BRANCH" \
              --body "### Automated Pull Request\n\nThis PR was automatically generated by the 'Auto PR on Final Commit' workflow.\n\n- **Source Branch:** \`$SOURCE_BRANCH\`\n- **Target Branch:** \`$TARGET_BASE_BRANCH\`\n\nTriggered by a commit containing 'final commit'.\n\n---" \
              --base "$TARGET_BASE_BRANCH" \
              --head "$SOURCE_BRANCH" \
              --label "auto-pr" \
              --assignee "@me" \
              --reviewer "your-teammate-github-username" \
              --milestone "v1.0"
          )

          PR_URL=$(echo "$PR_OUTPUT" | jq -r '.url')
          PR_NUMBER=$(echo "$PR_OUTPUT" | jq -r '.number')

          echo "✅ PR created: $PR_URL"
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Print PR URL
        if: success() # Only run this step if the previous 'create_pr' step was successful
        run: |
          echo "🔗 PR: ${{ steps.create_pr.outputs.pr_url }}"
